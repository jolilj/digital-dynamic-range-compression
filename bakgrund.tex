\documentclass[]{article}
\usepackage{natbib}
\usepackage{tikz}
\usetikzlibrary{shapes,arrows}
\usepackage{textcomp}
\usepackage{pgfplots}
\usepackage{caption}
\usepackage{subcaption}
\usepackage[swedish,english]{babel}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}

\begin{document}

\title{Digital Dynamic Range Compression Algorithm Design at KlevgrÃ¤nd Production AB}
\author{J. Lilja, O. Karlsson}
\date{2014-02-01}
\maketitle

\begin{abstract}
TODO
\end{abstract}

\clearpage
\section{Introduction}
TODO
\section{Background}
\subsection{Dynamical range compression}
The dynamic range compressor is a complex nonlinear time dependent system where the the amplitude peaks of a signal is suppressed, reducing its dynamic range. In figure \ref{fig:xy-graph} the eligible behaviour of a simple compression process is illustrated. The x- and y-axis represents the logarithmic amplitude of input and output signal respectively. As the input signal rise above the threshold level, compression is applied. Logarithmic scale is used since sound amplitude is, by standard, expressed in the logarithmic unit decibel.

In practice, however, is is not desirable to apply instant compression since it introduces distortion\cite{giannoullis}. We thus want to smooth out the compression applied over time. This is illustrated in figure \ref{fig:envelope-graph}.

\begin{figure}[ht]
\captionsetup{justification=centering}
\begin{minipage}[t]{.5\textwidth}
 \centering
\input{XY-graph}
\caption{Output signal vs input signal.} 
\label{fig:xy-graph}
\end{minipage}%
\begin{minipage}[t]{.5\textwidth}
\centering
\input{envelope}
\caption{Input and output signal plotted over time. } 
\label{fig:envelope-graph}
\end{minipage}
\end{figure}

In order to analyse the compression process we define the following parameters
\begin{itemize}
\item{\textbf{Threshold} - The defined limit above which compression is applied }
\item{\textbf{Ratio} - The input/output ratio above the threshold level. Determines the amount of compression}
\item{\textbf{Attack time} - Determines how quickly the compression ratio is applied.}
\item{\textbf{Release time} - Determines how quickly the compression is released as the input signal drops below the threshold level.}
\item{\textbf{Knee width} - Controls the sharpness of the knee, see figure \ref{fig:xy-graph}.}
\end{itemize}



\subsection{Gain Computer}
The heart in any compressor design is where the gain reduction is applied. Here the amplitude of the input signal is reduced by the gain factor $g_n$, see figure \ref{fig:gain-step-blockdiagram}. Denoting input and output signal $x_n$ and $y_n$ respectively, we have
\begin{align}
y_n = x_n g_n.
\label{eq:inout}
\end{align}
To derive the gain factor, $g_n$ we begin by examining the eligible behaviour of the compressor according to figure \ref{fig:xy-graph}. Denoting the threshold level $T$ and the ratio $R$, we get
\begin{equation} \label{eq:gaincomp}
Y = \left\{ 
  \begin{array}{l l}
    T+ \dfrac{X-T}{R} & \quad \text{if $X > T$}\\
    X & \quad \text{otherwise.}
  \end{array} \right.
\end{equation}
The component generating the gain factor is defined as the \emph{gain computer}. We now face two different approaches: feeding the gain computer with the uncompressed input or the compressed output signal resulting in a feed-forward or feedback system, see figure \ref{fig:feedforward-blockdiagram} and \ref{fig:feedback-blockdiagram}. 
\begin{figure}[ht]
 \centering
\input{feedforward-blockdiagram}
\caption{Block diagram of feed forward design}
\label{fig:feedforward-blockdiagram}
\end{figure}
\begin{figure}[ht]
\centering
\input{feedback-blockdiagram}
\caption{Block diagram of feedback design} 
\label{fig:feedback-blockdiagram}
\end{figure}
\\ To derive $g_n$ we begin with the relationship between the input and output signal.
\begin{align}
y_n &= x_ng_n   \\
\log|y_n| & = \log|x_n| + \log|g_n|   \\
Y &= X + G \label{eq:cv}
\end{align}
\\ where the logarithmic variables are denoted by capital letters. For a compressor the output is never amplified, hence $g_n \leq 1$. In \cite{giannoullis} it is shown that a feedback compressor cannot function as a perfect limiter. Furthermore it lacks the ability for look-ahead, see TODO refer to section explaining look ahead. Therefor we leave the feedback compressor design aside. 

In a feed-forward design the logarithmic input signal, $X$,  is inserted into the gain computer, thus equation (\ref{eq:cv}) and (\ref{eq:gaincomp}) yields
\begin{equation}
X+G = \left\{ 
  \begin{array}{l l}
    T+ \dfrac{X-T}{R} & \quad \text{if $X > T$}\\
    X & \quad \text{otherwise.}
  \end{array} \right.
\end{equation}
\\Solving for $G \rm \Rightarrow$
\begin{equation} \label{eq:c}
G = \left\{ 
  \begin{array}{l l}
    \left(R^{-1}-1\right)(X-T)& \quad \text{if $X > T$}\\
    0 & \quad \text{otherwise.}
  \end{array} \right.
\end{equation}
\begin{align}
G = (R^{-1}-1)\cdot \max\left(Y-T,0\right).
\end{align}

\subsection{Peak detector}
So far, we have assumed that the gain computer acts directly on the input signal in a time-independent fashion. To make the compressor act on the \emph{envelope} of the input signal instead, with the smooth time dependent behaviour depicted in figure \ref{fig:envelope-graph}, we introduce a \emph{peak detector} component.

There are two ways to look at this:
\begin{enumerate}
\item Smoothing of the input signal with a low pass filter.
\item Implementing a system with an (exponential) asymptotical step response in the time domain.
\end{enumerate}

This is the same thing. \emph{Text about impulse response, FIR filters, IIR filters, transfer functions etc. Need matlab-graphs for this. coming soon!}.

\begin{figure}[ht]
\centering
\input{attack-release-graph}
\caption{Desired peak detector step response, attack and release phase} 
\label{fig:attack-release-graph}
\end{figure}

\subsubsection{The discrete exponential, IIR filter}
\emph{Derivation of the below expression here!}

\begin{equation}
y_k = \left\{
  \begin{array}{ll}
    \alpha_{att} x_k + (1-\alpha_{att})y_{k-1} & \text{if }  x_k > y_{k-1} \\
    \alpha_{rel} x_k + (1-\alpha_{rel})y_{k-1} & \text{otherwise} 
  \end{array}
\right.
\end{equation}
where
\begin{equation}
\begin{array}{lr}
\alpha_{att} = 1-e^{1/f_s \tau_{att}}, & \alpha_{rel} = 1-e^{1/f_s \tau_{rel}}
\end{array}
\end{equation}

\subsubsection{Peak, RMS and Crest factor}
We can further smooth the peak detector envelope by taking the RMS of the input signal. \emph{something about number of samples to take mean over}

This will also allow us to calculate the \emph{Crest factor} defined as
\begin{equation}
y_{crest} = \frac{y_{peak}}{y_{RMS}}
\end{equation}
which can be used to detect transients.

\subsubsection{Log or linear domain}
Assuming that we choose the exponential function as our attack and release trajectory, we can either implement this in the logarithmic or the linear domain. In the logarithmic domain, we will get an exponential temporal evolution of the compression in dB (\emph{need to have text about log and dB somewhere explaining this...}.) On the other hand, if the function is exponential in the linear domain, it will be linear in the logarithmic domain, which presumably will not be as smooth to the human ear (but worth investigating!).

\subsubsection{Placement in block diagram}
Furthermore, we can choose to place the peak detector either before or after the gain computer. Placed before the gain computer, we will feed the gain computer not with the input signal, but with our computed envelope. \emph{This will lead to slow attack, since the attack time will begin below the threshold etc...}
Another option is to place it \emph{after} the gain computer. This way the gain computer acts on the input signal, and we feed the peak detector with the control voltage instead of the raw input signal, calculating a smooth envelope on this instead. \emph{maybe some graphs and block diagrams depicting this difference...}

\emph{TODO: Investigate how this affects the transfer functions etc... If it was a linear system this would not matter? Maybe interesting to do some math on the importance of the order of components in this nonlinear system}

\bibliographystyle{plain}
\bibliography{reflist}
\end{document}
