\documentclass[]{article}
\usepackage{natbib}
\usepackage{tikz}
\usetikzlibrary{shapes,arrows}
\usepackage{textcomp}
\usepackage{pgfplots}
\usepackage{caption}
\usepackage{subcaption}
\usepackage[swedish,english]{babel}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}

\begin{document}

\title{Digital dynamic range compression algorithm design att KlevgrÃ¤nd Production AB}
\author{J. Lilja, O. Karlsson}
\date{2014-02-01}
\maketitle

\begin{abstract}
In this study/paper/report, we investigate...
\end{abstract}

\clearpage
\section{Introduction}
\section{Background}
\subsection{Dynamical range compression}
The dynamic range compressor is a complex nonlinear time dependent system where the the amplitude peaks of a signal is suppressed, reducing its dynamic range. The complexity of the system together with the vast set of design choices makes it difficult to draw a generic block diagram of the process\cite{giannoullis}  and thus we will, in the analysis, focus on a digital implementation corresponding to ideal components of it's analogue counterpart. 

In figure \ref{fig:xy-graph} the eligible behaviour of a simple compression process is illustrated. The x- and y-axis represents the logarithmic amplitude of input and output signal respectively. As the input signal rise above the threshold level, compression is applied. Logarithmic scale is used since sound amplitude is, by standard, expressed in the logarithmic unit decibel.

In practice, however, is is not desirable to apply instant compression since it introduces distortion\cite{giannoullis}. We thus want to smooth out the compression applied over time. This is illustrated in figure \ref{fig:envelope-graph}.

\begin{figure}[ht]
\captionsetup{justification=centering}
\begin{minipage}[t]{.5\textwidth}
 \centering
\input{XY-graph}
\caption{Output signal vs input signal.} 
\label{fig:xy-graph}
\end{minipage}%
\begin{minipage}[t]{.5\textwidth}
\centering
\input{envelope}
\caption{Input and output signal plotted over time. } 
\label{fig:envelope-graph}
\end{minipage}
\end{figure}

In order to analyse the compression process we define the following parameters
\begin{itemize}
\item{\textbf{Threshold} - The defined limit above which compression is applied }
\item{\textbf{Ratio} - The input/output ratio above the threshold level. Determines the amount of compression}
\item{\textbf{Attack time} - Determines how quickly the compression ratio is applied.}
\item{\textbf{Release time} - Determines how quickly the compression is released as the input signal drops below the threshold level.}
\item{\textbf{Knee width} - Controls the sharpness of the knee, see figure \ref{fig:xy-graph}.}
\end{itemize}



\subsection{Gain-reduction}
We begin our derivation of a block diagram for a generic compressor with the gain reduction step. This is where the signals amplitude is modified and it is achieved with a \emph{Voltage Controlled Amplifier} (VCA).

In the analog history of compressor design, various different circuit types have been implemented for this task (FET, optical circuits, tube amplifiers etc.), each with it's own characteristic. Modern solid state compressors that use integrated circuits for gain control is sometimes called \emph{VCA compressors}. In this paper however, we will use the term VCA as a generic term for any controllable amplifier.

\begin{figure}[ht]
\centering
\input{vca-generic-blockdiagram}
\caption{Block diagram of gain reduction step} 
\label{fig:vca-generic-blockdiagram}
\end{figure}

\subsubsection{Ideal VCA}
At least in a mathematical sense, an "ideal" VCA can be modeled as perfectly linear:
\begin{equation}
	y(t) = x(t) c_v
\end{equation}
where $y(t)$ is the output, $x(t)$ the input, and $c_v$ the control voltage.

\subsection{Feed-forward, feedback}
To compute the control voltage, we can choose to have an open loop/feed-forward design (figure \ref{fig:feedforward-blockdiagram}), or a closed loop/feedback design (figure \ref{fig:feedback-blockdiagram}). In analog compressor design this have implications for the amplitude range the components will have to handle, and also how well the gain computer can compensate for non-linearities in the VCA. This is not relevant to our digital implementation, but as we will see in our derivation of the gain computer it will affect the compression ratio possible to achieve.

\begin{figure}[ht]
\centering
\input{feedforward-blockdiagram}
\caption{Block diagram of feed forward design}
\label{fig:feedforward-blockdiagram}
\end{figure}

\begin{figure}[ht]
\centering
\input{feedback-blockdiagram}
\caption{Block diagram of feedback design} 
\label{fig:feedback-blockdiagram}
\end{figure}

\subsection{Gain computer}
According to figure \ref{fig:xy-graph} and denoting the threshold level $T$ and the ratio $R$, we get
\begin{equation} \label{eq:gaincomp}
Y = \left\{ 
  \begin{array}{l l}
    T+ \dfrac{X-T}{R} & \quad \text{if $X > T$}\\
    X & \quad \text{otherwise.}
  \end{array} \right.
\end{equation}
\\Modelling an ideal VCA using the exponential of the control voltage, $c$, yields
\begin{align}
y &= xe^{c}   \\
\log|y| & = \log|x| + c   \\
Y &= X + c \label{eq:cv}
\end{align}
\\Negative control voltage corresponds to compression while zero control voltage leaves the input signal uncompressed. 

In a feedback design the control voltage is a function of the output signal and thus equation (\ref{eq:cv}) and (\ref{eq:gaincomp}) yields
\begin{equation}
Y = \left\{ 
  \begin{array}{l l}
    T+ \dfrac{Y-c-T}{R} & \quad \text{if $X > T$}\\
    Y-c & \quad \text{otherwise.}
  \end{array} \right.
\end{equation}
\\Solving for $c \rm \Rightarrow$
\begin{equation} \label{eq:c}
c = \left\{ 
  \begin{array}{l l}
    (1-R)(Y-T)& \quad \text{if $Y-c > T$}\\
    0 & \quad \text{otherwise.}
  \end{array} \right.
\end{equation}
\\Rewrite the limit for $c$
\begin{align*}
Y - c  = Y-(1-R)(Y-T) = T + R(Y-T) > T.   \\
\end{align*}
\\Hence 
\begin{align*}
Y-c > T \Longleftrightarrow R(Y-T)  > 0.
\end{align*}
\\And assuming $R > 0$
\begin{align} \label{eq:feedbacklimit}
Y > T.
\end{align}
\\Inserting equation (\ref{eq:feedbacklimit}) into (\ref{eq:c}) allow us to write the control voltage as
\begin{align}
c = (1-R)\cdot max\left(Y-T,0\right)
\end{align}
\\In the case of a ideal limiter ($R = \infty$) an infinite negative amplification is needed to calculate the control voltage. A perfect limiter is thus impossible to implement with a feedback design.

\subsection{Peak detector}
So far, we have assumed that the gain computer acts directly on the input signal in a time-independent fashion. To make the compressor act on the \emph{envelope} of the input signal instead, with the smooth time dependent behaviour depicted in figure \ref{fig:envelope-graph}, we introduce a \emph{peak detector} component.

There are two ways to look at this:
\begin{enumerate}
\item Smoothing of the input signal with a low pass filter.
\item Implementing a system with an (exponential) asymptotical step response in the time domain.
\end{enumerate}

This is the same thing. \emph{Text about impulse response, FIR filters, IIR filters, transfer functions etc. Need matlab-graphs for this. coming soon!}.

\begin{figure}[ht]
\centering
\input{attack-release-graph}
\caption{Desired peak detector step response, attack and release phase} 
\label{fig:attack-release-graph}
\end{figure}

\subsubsection{The discrete exponential, IIR filter}
\emph{Derivation of the below expression here!}

\begin{equation}
y_k = \left\{
  \begin{array}{ll}
    \alpha_{att} x_k + (1-\alpha_{att})y_{k-1} & \text{if }  x_k > y_{k-1} \\
    \alpha_{rel} x_k + (1-\alpha_{rel})y_{k-1} & \text{otherwise} 
  \end{array}
\right.
\end{equation}
where
\begin{equation}
\begin{array}{lr}
\alpha_{att} = 1-e^{1/f_s \tau_{att}}, & \alpha_{rel} = 1-e^{1/f_s \tau_{rel}}
\end{array}
\end{equation}

\subsubsection{Peak, RMS and Crest factor}
We can further smooth the peak detector envelope by taking the RMS of the input signal. \emph{something about number of samples to take mean over}

This will also allow us to calculate the \emph{Crest factor} defined as
\begin{equation}
y_{crest} = \frac{y_{peak}}{y_{RMS}}
\end{equation}
which can be used to detect transients.

\subsubsection{Log or linear domain}
Assuming that we choose the exponential function as our attack and release trajectory, we can either implement this in the logarithmic or the linear domain. In the logarithmic domain, we will get an exponential temporal evolution of the compression in dB (\emph{need to have text about log and dB somewhere explaining this...}.) On the other hand, if the function is exponential in the linear domain, it will be linear in the logarithmic domain, which presumably will not be as smooth to the human ear (but worth investigating!).

\subsubsection{Placement in block diagram}
Furthermore, we can choose to place the peak detector either before or after the gain computer. Placed before the gain computer, we will feed the gain computer not with the input signal, but with our computed envelope. \emph{This will lead to slow attack, since the attack time will begin below the threshold etc...}
Another option is to place it \emph{after} the gain computer. This way the gain computer acts on the input signal, and we feed the peak detector with the control voltage instead of the raw input signal, calculating a smooth envelope on this instead. \emph{maybe some graphs and block diagrams depicting this difference...}

\emph{TODO: Investigate how this affects the transfer functions etc... If it was a linear system this would not matter? Maybe interesting to do some math on the importance of the order of components in this nonlinear system}

\bibliographystyle{plain}
\bibliography{reflist}
\end{document}
