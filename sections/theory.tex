\documentclass[../main2.tex]{subfiles}
%if compiling standalone, rootdir wil be previous folder,
%if compiling main document, rootdir will already be set by main file
\providecommand{\rootdir}{..}

\begin{document}

\section{Theory}\label{sec_theory}
In this section the theory behind digital dynamic range compression is described. It is structured in relation to previous research where each subsection deals with the theory and method of corresponding work described in ~\ref{background}. However, a brief introduction with definition of necessary parameters is conducted in the first paragraph. 

\subsection{Definitions} \label{theory_definitions}
A DDRC maps the dynamic range of a signal to a smaller, compressed, range. In order to describe the behaviour the following parameters, corresponding to static and time dependent characteristics, are introduced.
%================================
\begin{itemize}
\item{Static}
	\begin{itemize}
	\item \textbf{Threshold} $T$ - The defined limit above which compression is applied.
	\item \textbf{Ratio} $R$ - The input/output ratio above the threshold level.
	\item \textbf{Knee width}  $W$ - Controls the sharpness of the knee.
	\item \textbf{Make-up gain}  $M$ - The amount of gain applied in the final step to balance the perceived loudness of the output signal with the input signal.
\end{itemize}
\item{Time Dependent}
	\begin{itemize}
	\item \textbf{Attack time} $\tau_{a}$ - Determines how quickly the compression ratio is applied.
	\item \textbf{Release time} $\tau_{r}$ - Determines how quickly the compression is released as the input signal drops below the threshold level.
	\item \textbf{Look-ahead} $d_{la}$ - Difference in delay between direct signal path and side chain. 
	\item \textbf{Sample frequency} $f_{s}$ - Indirectly connected to the time dependent characteristics through the time constants
	\end{itemize}
\end{itemize}
%================================
\begin{figure}
\centerline{\subfile{\rootdir/figures/typical_static_detailed}}
\caption{Typical static characteristics of a DDRC}
\label{fig:typical_static_detailed}
\end{figure}
%================================
The static characteristics are depicted in Fig ~\ref{fig:typical_static_detailed}. Do note that the static curve is defined in the log-domain, hence capital letters. There are two ways of handle the threshold level, $T$, either with a sharp knee immediately switching slope from $1$ to $1/R$, or with a smooth transition by an intermediate second degree polynomial\cite{frindle1996implementation}\cite{reiss2012tutorial}. Thus $W$ is defined as the range in dB spanning either side of $T$ where such a polynomial is connected. The conditions to be met is for the polynomial to be continuous and have continuous derivatives at the points $X=T-W/2$ and $X=T+W/2$. A knee width of $W=0$ corresponds to a sharp knee. The make-up gain is defined as a constant amount of gain added to the signal. Since the compressor lowers the amplitude of the signal, the perceived loudness decreases. Make-up gain is used to balance the loudness of the output with the input.
The time dependent characteristics are depicted in Fig ~\ref{fig:typical_envelope_detailed}. The time constants, $\tau_{att}$ and $\tau_{rel}$, referred to as attack time and release time, can be seen as a measure of the reaction time of the compressor. There are various ways of defining them. In \cite{mcnally1984dynamic} the attack time is defined as the time it takes to achieve 63.2 \% of the final change in gain in accordance with the conventional notion. The same applies to the release time such as the time it takes for the output to reach 63.2\% of the input value as it has decreased below the threshold level. The definitions can be understood by noting that with exponential characteristics
%================================
\begin{align}
1-e^{-t / \tau}\rvert_{t=\tau} = 1-e^{-1} \approx 63.2 \% \label{eq:time_const}
\end{align}
%================================
If not specified otherwise this definition will be used throughout the thesis.

Another definition of the time constant, used in a more general DRC context ~\cite{mcnally1984dynamic}, is the time it takes to achieve 90 \% of the final gain change. These time constants will be referred to as $\tau_{a90}$ and $\tau_{r90}$ for attack and release respectively, see Fig ~\ref{fig:time_constants}.
%================================
\begin{figure}
\centerline{\subfile{\rootdir/figures/typical_envelope_detailed}}
\caption{Typical dynamic characteristics of a DDRC. With a look-ahead delay sharp transients are effectively compressed.}
\label{fig:typical_envelope_detailed}
\end{figure}
%================================
%================================
\begin{figure}
\centerline{\subfile{\rootdir/figures/time_constants}}
\caption{Illustration of the defined time constants.}
\label{fig:time_constants}
\end{figure}

As can be seen in Fig ~\ref{fig:typical_envelope_detailed} the look-ahead, $d_{la}$, is defined as the applied delay to the input signal before the gain reduction, thus having the gain applied time-shifted. Sharp transients can thus be compressed effectively despite the smooth attack phase.

\subsection{Side Chain Topologies}
Something very short on feed forward and feed backward, as well as mono vs stereo compressors.
Here we introduce our generic block diagram that can incorporate all designs mentioned in background.

\subfile{\rootdir/sections/theory_mcnally}

\subfile{\rootdir/sections/theory_stikvoort}

\subsection{Side Chain Components}

\subsubsection{Filters}
Input signal is denoted by $x_k$ and the output signal is denoted by $y_k$, regardless of filter placement in the side chain. They are, so to speak, local variables to this subsection. We use the term filter here to emphasise their purpose of smoothing out high frequencies in the side chain, even though most of them are highly nonlinear and cannot be used on arbitrary signals as they demand the input to be above or equal to zero.

No standard naming convention can be found in the literature apart from general descriptions of order and number of poles. Thus, the names presented here are our own, and for our own convenience. However, we have tried to follow Reiss' categorisation as close as possible.

\paragraph{One pole averaging IIR filter}
This filter is used by McNally to take the average of the squared input samples in the RMS level detector. In that context the square root should be taken of the output before feeding it to the gain computer. The constant $\alpha_{av}$ can thus be seen as a moving average RMS weight, but also as a time constant in a one pole IIR low pass filter.

\begin{equation}
y_k = \alpha_{av}x_k + (1-\alpha_{av}) y_{k-1}
\end{equation}

\paragraph{One pole coupled IIR filter}
This filter is used for peak level detector smoothing in McNally and Zoelzer 97.
\begin{equation}
y_k = \begin{cases}
    \alpha_{att} x_k + (1- (\alpha_{att} + \alpha_{rel})) y_{k-1}  	& x_k > y_{k-1} \\
    (1-\alpha_{rel}) y_{k-1} 								& x_k \leq y_{k-1}
\end{cases}
\end{equation}

Reiss shows that it can be derived as an ideal model of a simple analog RC-circuit design. Reiss also points out that the attack time as well as the peak estimate is scaled by the release time, which is why we choose to call it "coupled" in this paper. This scaling behavior can be seen in fig XXX.

\paragraph{One pole branching IIR filter}
This is an improved version of the coupled IIR filter, described in Zoelzer 05, where the release time constant is removed from the attack phase so that the level measurement and attack time is no longer scaled with release time.
\begin{equation}
y_k = \begin{cases}
    \alpha_{att} x_k + (1-\alpha_{att}) y_{k-1} 	& x_k > y_{k-1} \\
    (1-\alpha_{rel}) y_{k-1} 					& x_k \leq y_{k-1}
\end{cases}
\end{equation}

\paragraph{One pole branching, smooth, IIR filter}
This is a design proposed for peak level detector smoothing in Reiss. It is called "smooth" because it falls off in a smooth exponential towards $x_k$ in the release phase. This is to be contrasted with the one pole branching IIR filter above that falls off towards zero, regardless of $x_k$, yielding a discontinuity when $x_k > 0$ as can be seen in figure XX.
\begin{equation}
y_k = \begin{cases}
    \alpha_{att} x_k + (1-\alpha_{att}) y_{k-1} 	& x_k > y_{k-1} \\
    \alpha_{rel} x_k + (1-\alpha_{rel}) y_{k-1} 	& x_k \leq y_{k-1}
\end{cases}
\end{equation}

It is possibly also suggested for gain smoothing in McNally and Zoelzer. The block diagrams in McNally, Zoelzer97, Zoelzer05, DAFX02 and DAFX11 all suggest that the branching condition is determined by $x_k > x_{k-1}$, that is, by comparing the current and previous \emph{input} samples instead of comparing the current input with the previous \emph{output}. However, when described in a code snippet appearing for the first time in DAFX11, the branching condition of eq XX is actually used. Bitzer06 refers to McNally and DAFX02 for their implementation of this filter, but also use the branching condition of eq XX. It is unclear what the original intent was in McNally's block diagram from 1984.

\paragraph{Decoupled IIR filter}
This filter is derived in Reiss, as a "Decoupled peak detector". It has the same attack trajectory as the branching filter, but the release trajectory is a combination of attack and release envelopes.

\begin{equation}
\begin{split}
z_k &= \begin{cases}
    x_k 								& x_k > z_{k-1} \\
   (1-\alpha_{rel}) z_{k-1} 					& x_k \leq z_{k-1}
\end{cases} \\
y_k &= \alpha_{att} z_k + (1-\alpha_{att}) y_{k-1}
\end{split}
\end{equation}
The name "decoupled" can be discussed, since the release trajectory is actually coupled with the attack time constant in contrast to the branching detector. The name is Reiss' convention, and can be understood from it's analog counterpart.

\paragraph{Decoupled smooth IIR filter}
This is an adjusted version of the above filter, analogous to the modification of the branched filter to it's smoothed counterpart.

\begin{equation}
\begin{split}
z_k &= \begin{cases}
    x_k 								& x_k > z_{k-1} \\
    \alpha_{rel} x_k + (1-\alpha_{rel}) z_{k-1} 	& x_k \leq z_{k-1}
\end{cases} \\
y_k &= \alpha_{att} z_k + (1-\alpha_{att}) y_{k-1}
\end{split}
\end{equation}

\paragraph{Stickvoort three pole release filter}
\begin{equation}
y_k = c^k+ k c^k (c - 1)(c - 3)/2 + k^2 c^k (1 - c)^2/2
\end{equation}

\begin{equation}
\begin{split}
u_k &= \text{max}(x_k, \alpha_{rel} u_{k-1}) \\
v_k &= \text{max}(x_k, \alpha_{rel} v_{k-1} + (1-\alpha_{rel}) u_k) \\
w_k &= \text{max}(x_k, \alpha_{rel} w_{k-1} + (1-\alpha_{rel}) v_k)\\
y_k &= w_{k-1} \\
\end{split}
\end{equation}

\paragraph{Time constants}
All time constants in the above are defined in the same way, here only denoted by $\alpha$, and given by

\begin{equation}
\alpha = 1- e^{-T/ \tau},
\end{equation}
where $\tau$ is the usual time constant denoting the time it takes a decaying exponential function to reach $63 \%$ of it's final value.


\end{document}}