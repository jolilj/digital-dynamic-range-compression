\documentclass[../main2.tex]{subfiles}
%if compiling standalone, rootdir wil be previous folder,
%if compiling main document, rootdir will already be set by main file
\providecommand{\rootdir}{..}

\begin{document}

\subsection{Peak Level Detection}

\subsubsection{Parameter Optimisation}
The frequency of the fine structure as defined in Eq.~\eqref{eq:eq_test_signal} was set to $f_c = 10$ kHz and the envelope modulation frequency was set to $f_m = 2$ Hz. The sampling frequency was $44.1100$ kHz. The parameters for each peak detector was optimised, and their optimised values can be seen in Tab.~\ref{tab:peak_det_opt_params} together with the resulting normalised euclidian distance to ideal. The resulting envelopes can be seen in Fig.~\ref{fig:peak_det_opt_env}. The envelopes are offset in relation to each other for clarity, with the ideal envelope dotted for each offset. 

\begin{table}[h]
\begin{center}
\caption{Optimised parameters for the various peak detectors, $f_c=10 $  kHz, $f_m=2 $}
\label{tab:peak_det_opt_params}
\caption*{(a) Attack and release peak detectors}
\begin{tabular}{| l | c c c | c |}
	\hline
	Detector 	& $\tau_\text{a}$ [ms] & $\tau_\text{r}$ [ms] & $d$ [samples] & error [1/sample]\\
	\hline
	
	Analog 			& 0 			& 135.6 	& 16	(0.36 ms)	& ?	\\ 
	Branching smooth 	& 0	 		& 49.6 	& 17	(0.39 ms)	& ?	\\ 
	Cascaded smooth	& 1.2		& 49.5 	& 69	(1.56 ms)	& ?	\\
	\hline
\end{tabular}
\end{center}

\begin{center}
\caption*{(b) Windowed peak detectors}
\label{tab:peak_det_instatt_opt_params}
 \begin{tabular}{| l | c c  | c |}
	\hline
	Detector & $w$ [samples] & $d$ [samples] & error [1/sample] \\
	\hline
	Win. Max		& 53		& 26	(0.59 ms)	& ?	\\ 
	\hline
\end{tabular}
\end{center}

\end{table}

%======================
\begin{figure}[h]
\centerline{\subfile{\rootdir/figures/peak_det_opt_env}}
\caption{Optimised peak detector envelopes, vertical offset by 0.2 for clarity. The vertical lines at 0.05 s and 0.95 s mark the start and end of the region for which $\EN$ was calculated.}
\label{fig:peak_det_opt_env}
\end{figure}
%======================
\begin{figure}

\captionsetup{justification=centering}
\begin{subfigure}{\linewidth}
\centering
\centerline{\subfile{\rootdir/figures/peak_det_opt_env_attack}}
\caption{Peak detector envelopes, zoomed in at the maximum amplitude}
\end{subfigure}

\par\bigskip

\captionsetup{justification=centering}
\begin{subfigure}{\linewidth}
\centering
\centerline{\subfile{\rootdir/figures/peak_det_opt_env_release}}
\caption{Peak detector envelopes, zoomed in at the minimum amplitude}
\end{subfigure}

\caption{Zoomed in versions of optimised peak detector envelopes, vertically offset by 0.01 for clarity}
\label{fig:peak_det_opt_env_zoom}
\end{figure}
%======================

\subsubsection{Carrier Frequency Dependence}
The parameters were fixed from the previous optimisation, and the carrier frequency swept from 20 Hz to $20$ kHz. The result can be seen in Fig.~\ref{fig:peak_det_opt_env_fc_dep}.

%======================
%======================
\begin{figure}[h]
\captionsetup{justification=centering}
%======================
\begin{subfigure}{\linewidth}
\centerline{\subfile{\rootdir/figures/peak_det_opt_env_fc10000_dep_error}}
\end{subfigure}
%======================
\par\bigskip
%======================
\begin{subfigure}{\linewidth}
\centerline{\subfile{\rootdir/figures/peak_det_opt_env_fc10000_dep_error_zoom}}
\end{subfigure}
\caption{$\EN$ of the peak detectors plotted against carrier frequency with optimised parameters at $f_c=10$ kHz}
\label{fig:peak_det_opt_env_fc10000_dep_error}
\end{figure}
%======================
%======================

%======================
%======================
\begin{figure}[h]
\captionsetup{justification=centering}
%======================
\begin{subfigure}{\linewidth}
\centerline{\subfile{\rootdir/figures/peak_det_opt_env_fc10000_dep_fes}}
\end{subfigure}
%======================
\par\bigskip
%======================
\begin{subfigure}{\linewidth}
\centerline{\subfile{\rootdir/figures/peak_det_opt_env_fc10000_dep_fes_zoom}}
\end{subfigure}
\caption{$\FES$ of the peak detectors plotted against carrier frequency with optimised parameters at $f_c=10$ kHz}
\label{fig:peak_det_opt_env_fc10000_dep_fes}
\end{figure}
%======================
%======================

\FloatBarrier
\subsubsection{Theoretical Benefit of Upsampling}
The test signal was generated at 8 times the sample rate, $f_s = 8000$, and the same test as above was run again. The parameters values was optimised again yielding the values in Tab.~\ref{tab:peak_det_opt_params_up}. The result can be seen in Fig.~\ref{peak_det_opt_env_th_up} and Fig.~\ref{fig:peak_det_opt_env_fc_dep_th_up}.
The envelopes have now become extremely smooth, and the carrier frequencies that evenly divides the sampling frequency is considerably less problematic. The windowed detectors however get a rapidly increasing error as the carrier frequency drops below the frequency the parameters was optimised for.

In practice, the up-sampled signal would have to be interpolated by an interpolating filter, and then down-sampled again after the level detector or later in the side-chain. This will probably downgrade the results seen here.\todo{discussion?}

\begin{table}[h]
\begin{center}
\caption{Optimised parameters for the various peak detectors, $f_c=1000/\pi $, $f_m=2 $}
\label{tab:peak_det_opt_params_up}
\caption*{(a) Attack and release peak detectors}
\begin{tabular}{| l | c c c | c |}
	\hline
	Detector 	& $\tau_\text{a}$ [ms] & $\tau_\text{r}$ [ms] & $d$ [samples] & error [1/sample]\\
	\hline
	
	Analog 			& 0 			& 141 	& 8		& 0.0067	\\ 
	Branching smooth 	& 0	 		& 52 	& 8		& 0.0067	\\ 
	Cascaded smooth	& 1.8		& 52 	& 22		& 0.0056	\\
	\hline
\end{tabular}
\end{center}

\begin{center}
\caption*{(b) Windowed peak detectors}
\label{tab:peak_det_instatt_opt_params}
 \begin{tabular}{| l | c c c | c |}
	\hline
	Detector & $w$ [samples] & $\tau_\text{av}$ [ms] & $d$ [samples] & error [1/sample] \\
	\hline
	Win. Max		& 33		& -		& 16		& 0.0034	\\ 
	Win. Max Filt.	& 33		& 42		& 49		& 0.0017	\\
	\hline
\end{tabular}
\end{center}
\end{table}
%======================
\subsection{RMS Level Detection}
The method is analogue to the peak detection case. However, as the RMS window length is highly dependent on the carrier frequency, the same procedure was repeated for $f_c = 20$ Hz as well. The optimised params can be seen in Tab.~\ref{tab:rms_det_opt_params}.  The resulting RMS outputs can be seen in Fig.~\ref{fig:rms_opt_10000}. Finally the carrier frequency dependence, with optimised params for $f_c=10$ kHz and $f_c=20$ Hz is plotted in Fig.~\ref{fig:rms_det_opt_env_fc10000_dep_error-fes} and Fig.~\ref{fig:rms_det_opt_env_fc10000_dep_error-fes}, respectively.
%======================
\begin{table}[h]
\begin{center}
\caption{Optimised parameters for the two RMS detectors}
\label{tab:rms_det_opt_params_10000}
\caption*{(a) Optimised for $f_c=10$ kHz}
 \begin{tabular}{| l | c c c | c |}
	\hline
	Detector & $w$ [samples] & $\tau_\text{av}$ [ms] & $d$ [samples] & error [1/sample] \\
	\hline
	IIR RMS		& -			& 4.64 	& 202 (4.58 ms)		& ?	\\ 
	Window RMS 	& 172	 		& - 	& 86	(1.95 ms)	& ?	\\ 
	\hline
\end{tabular}
\end{center}

\begin{center}
\caption*{(b) Optimised for $f_c=20$ Hz}
\label{tab:rms_det_opt_params_20}
 \begin{tabular}{| l | c c c | c |}
	\hline
	Detector & $w$ [samples] & $\tau_\text{av}$ [ms] & $d$ [samples] & error [1/sample] \\
	\hline
	IIR RMS			& - 			& 35.2 	& 1479 (33.5 ms)		& ?	\\ 
	Window RMS 	& 2206	 		& - 	& 1103 (25.0 ms)		& ?	\\ 
	\hline
\end{tabular}
\end{center}
\label{tab:rms_det_opt_params}
\end{table}
%======================
%======================
%======================
\begin{figure}[h]
\captionsetup{justification=centering}
%======================
\begin{subfigure}{\linewidth}
\centerline{\subfile{\rootdir/figures/rms_opt_10000}}
\caption{Whole signal}
\end{subfigure}
%======================
\par\bigskip
%======================
\begin{subfigure}{\linewidth}
\centerline{\subfile{\rootdir/figures/rms_opt_10000_zoom}}
\caption{Zoomed version}
\end{subfigure}
\caption{Optimised RMS detectors for $f_c=10$ kHz, vertical offset by 0.2 for clarity. The vertical lines at 0.05 s and 0.95 s mark the start and end of the region for which $\EN$ was calculated.}
\label{fig:rms_opt_10000}
\end{figure}
%======================
%======================
%======================
%======================
\begin{figure}[h]
\captionsetup{justification=centering}
%======================
\begin{subfigure}{\linewidth}
\centerline{\subfile{\rootdir/figures/rms_det_opt_env_fc10000_dep_error}}
\end{subfigure}
%======================
\par\bigskip
%======================
\begin{subfigure}{\linewidth}
\centerline{\subfile{\rootdir/figures/rms_det_opt_env_fc10000_dep_fes}}
\end{subfigure}
\caption{$\FES$ and $\EN$ of RMS detectors plotted against carrier frequency with optimised parameters at $f_c=10$ kHz}
\label{fig:rms_det_opt_env_fc10000_dep_error-fes}
\end{figure}
%======================
%======================
%======================
%======================
\begin{figure}[h]
\captionsetup{justification=centering}
%======================
\begin{subfigure}{\linewidth}
\centerline{\subfile{\rootdir/figures/rms_det_opt_env_fc20_dep_error}}
\end{subfigure}
%======================
\par\bigskip
%======================
\begin{subfigure}{\linewidth}
\centerline{\subfile{\rootdir/figures/rms_det_opt_env_fc20_dep_fes}}
\end{subfigure}
\caption{$\FES$ and $\EN$ of RMS detectors plotted against carrier frequency with optimised parameters at $f_c=20$ Hz}
\label{fig:rms_det_opt_env_fc10000_dep_error-fes}
\end{figure}
%======================
%======================

\end{document}